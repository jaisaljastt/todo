{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TODO App</title>
    <link rel="stylesheet" href="{% static 'home/style.css' %}" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-left">
          <h1 class="navbar-title">TODO</h1>
          <span class="navbar-subtitle">BY JST</span>
        </div>
        <div class="navbar-right">
          <span class="user-greeting">hello @{{request.user.username}}</span>
          <a
            class="logout-btn"
            style="text-decoration: none"
            href="{% url 'logout' %}"
            >LOGOUT</a
          >
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
      <!-- Add Task Section -->
      <div class="add-task-section">
        <h2 class="section-title">Add New Task</h2>
        <div class="add-task-form">
          <input
            type="text"
            id="taskInput"
            placeholder="Enter task description"
            class="task-input"
          />
          <input type="date" id="dateInput" class="date-input" />
          <button id="addTaskBtn" class="add-btn">Add Task</button>
        </div>
        <div class="current-date-display">
          <span>Showing tasks for: <span id="currentDateDisplay"></span></span>
        </div>
      </div>

      <!-- Tasks Table -->
      <div class="tasks-container">
        <div class="table-wrapper">
          <table class="tasks-table">
            <thead>
              <tr>
                <th>Task</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="tasksTableBody">
              <!-- Tasks will be inserted here by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Task Summary -->
      <div class="task-summary">
        <div class="summary-card">
          <div class="summary-count" id="todoCount">0</div>
          <div class="summary-label">Todo</div>
        </div>
        <div class="summary-card">
          <div class="summary-count" id="inprogressCount">0</div>
          <div class="summary-label">In Progress</div>
        </div>
        <div class="summary-card">
          <div class="summary-count" id="doneCount">0</div>
          <div class="summary-label">Done</div>
        </div>
        <div class="summary-card">
          <div class="summary-count" id="failedCount">0</div>
          <div class="summary-label">Failed</div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-container">
        <p>build by jst</p>
      </div>
    </footer>

    <script>
      // API configuration
      const API_BASE = "/api/tasks/";

      // Utility functions
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      function getTodayDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function getStatusClass(status) {
        return `status-${status}`;
      }

      // API calls
      async function fetchTasks(date) {
        try {
          const response = await fetch(`${API_BASE}?date=${date}`);
          const data = await response.json();
          return data.tasks || [];
        } catch (error) {
          console.error("Error fetching tasks:", error);
          return [];
        }
      }

      async function createTask(taskData) {
        const response = await fetch("/api/tasks/create/", {
          // <-- changed here
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(taskData),
        });
        return response.json();
      }

      async function updateTaskStatus(taskId, status) {
        const response = await fetch(`${API_BASE}${taskId}/update/`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ status }),
        });
        return response.json();
      }

      async function deleteTask(taskId) {
        const response = await fetch(`${API_BASE}${taskId}/delete/`, {
          method: "DELETE",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
          },
        });
        return response.json();
      }

      // Task management
      let tasks = [];
      let selectedDate = "";

      async function loadTasks() {
        tasks = await fetchTasks(selectedDate);
        renderTasks();
      }

      function getFilteredTasks() {
        return tasks.filter((task) => task.date === selectedDate);
      }

      function renderTasks() {
        const tbody = document.getElementById("tasksTableBody");
        const filteredTasks = getFilteredTasks();

        if (filteredTasks.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="3" class="no-tasks">
                No tasks for ${formatDate(
                  selectedDate
                )}. Add a task to get started!
              </td>
            </tr>
          `;
          updateSummary(filteredTasks);
          return;
        }

        tbody.innerHTML = filteredTasks
          .map(
            (task) => `
              <tr class="task-row">
                <td class="task-text">${task.text}</td>
                <td class="task-status">
                  <select class="status-select ${getStatusClass(task.status)}" 
                          onchange="handleStatusChange(${task.id}, this.value)">
                    <option value="todo" ${
                      task.status === "todo" ? "selected" : ""
                    }>Todo</option>
                    <option value="inprogress" ${
                      task.status === "inprogress" ? "selected" : ""
                    }>In Progress</option>
                    <option value="done" ${
                      task.status === "done" ? "selected" : ""
                    }>Done</option>
                    <option value="failed" ${
                      task.status === "failed" ? "selected" : ""
                    }>Failed</option>
                  </select>
                </td>
                <td class="task-action">
                  <button class="delete-btn" onclick="handleDeleteTask(${
                    task.id
                  })">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3,6 5,6 21,6"></polyline>
                      <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                  </button>
                </td>
              </tr>
            `
          )
          .join("");

        updateSummary(filteredTasks);
      }

      function updateSummary(filteredTasks = null) {
        const tasksToCount = filteredTasks || getFilteredTasks();
        document.getElementById("todoCount").textContent = tasksToCount.filter(
          (t) => t.status === "todo"
        ).length;
        document.getElementById("inprogressCount").textContent =
          tasksToCount.filter((t) => t.status === "inprogress").length;
        document.getElementById("doneCount").textContent = tasksToCount.filter(
          (t) => t.status === "done"
        ).length;
        document.getElementById("failedCount").textContent =
          tasksToCount.filter((t) => t.status === "failed").length;
      }

      function updateCurrentDateDisplay() {
        document.getElementById("currentDateDisplay").textContent =
          formatDate(selectedDate);
      }

      async function handleAddTask() {
        const taskInput = document.getElementById("taskInput");
        const dateInput = document.getElementById("dateInput");
        const taskDate = dateInput.value || getTodayDate();

        if (taskInput.value.trim()) {
          const newTask = {
            text: taskInput.value.trim(),
            status: "todo",
            date: taskDate,
          };

          try {
            await createTask(newTask);
            taskInput.value = "";
            await loadTasks();
          } catch (error) {
            console.error("Error creating task:", error);
          }
        }
      }

      async function handleDeleteTask(taskId) {
        if (confirm("Are you sure you want to delete this task?")) {
          try {
            await deleteTask(taskId);
            await loadTasks();
          } catch (error) {
            console.error("Error deleting task:", error);
          }
        }
      }

      async function handleStatusChange(taskId, newStatus) {
        try {
          await updateTaskStatus(taskId, newStatus);
          await loadTasks();
        } catch (error) {
          console.error("Error updating task status:", error);
        }
      }

      function handleDateChange() {
        const dateInput = document.getElementById("dateInput");
        selectedDate = dateInput.value || getTodayDate();
        updateCurrentDateDisplay();
        loadTasks();
      }

      // Event listeners
      document
        .getElementById("addTaskBtn")
        .addEventListener("click", handleAddTask);
      document
        .getElementById("taskInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            handleAddTask();
          }
        });
      document
        .getElementById("dateInput")
        .addEventListener("change", handleDateChange);

      // Initialize
      function init() {
        const dateInput = document.getElementById("dateInput");
        const today = getTodayDate();
        dateInput.value = today;
        selectedDate = today;
        updateCurrentDateDisplay();
        loadTasks();
      }

      // Initial render
      init();
    </script>
  </body>
</html>
